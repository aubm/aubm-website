<!doctype html>
<html>
<head>
    <base href="/">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="author" content="Aurélien Baumann (Aubm)">

<meta name="description" content="">

<title>Testing d&#39;une app golang sur AppEngine : une manière de gérer l&#39;erreur NewContext passed an unknown http.Request</title>
<meta name="generator" content="Hugo 0.19-DEV" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.1.0/styles/pojoaque.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.1.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:400,700" rel="stylesheet" type="text/css">
<link  href="http://www.aubm.net/css/theme.min.css" rel="stylesheet" type="text/css">

</head>
<body>
<div class="page-container container-fluid">
<div class="col-md-3 menu">
    <nav class="col-md-3">
    <h3 class="home-link"><a href="/">Racine</a></h3>
    <div id="last-posts" class="open">
        <h3 data-open="last-posts">Aubm - Les derniers articles</h3>
        <ul>
            
            <li><a href="http://www.aubm.net/blog/pourquoi-big-o-est-important/">Pourquoi Big O est important ?</a></li>
            
            <li><a href="http://www.aubm.net/blog/comment-vous-faire-une-idee-d-l-impact-de-la-latence-de-votre-televiseur-dans-vos-sessions-de-jeux-videos/">Comment vous faire une idée de l&#39;impact de la latence de votre téléviseur dans vos sessions de jeux vidéos</a></li>
            
            <li><a href="http://www.aubm.net/blog/testing-d-une-app-golang-sur-appengine-une-maniere-de-gerer-l-erreur-newcontext-passed-an-unknown-http-request/">Testing d&#39;une app golang sur AppEngine : une manière de gérer l&#39;erreur NewContext passed an unknown http.Request</a></li>
            
            <li><a href="http://www.aubm.net/blog/l-injection-de-dependances-a-l-esprit-dans-vos-applications-golang/">L&#39;injection de dépendances à l&#39;esprit dans vos applications Golang</a></li>
            
            <li><a href="http://www.aubm.net/blog/aller-plus-loin-avec-postman/">Aller plus loin avec Postman</a></li>
            
            <li><a href="http://www.aubm.net/blog/du-neuf-sous-le-capot/">Du neuf sous le capot</a></li>
            
            <li><a href="http://www.aubm.net/blog/gardez-le-code-explicite-court-et-modulaire/">Gardez le code explicite, court et modulaire</a></li>
            
            <li><a href="http://www.aubm.net/blog/contrainte-dunicite-dans-symfony-2-avec-doctrine/">Contrainte d&#39;unicité dans Symfony 2 avec Doctrine</a></li>
            
            <li><a href="http://www.aubm.net/blog/mes-premiers-pas-avec-cakephp-3/">Mes premiers pas avec CakePHP 3</a></li>
            
            <li><a href="http://www.aubm.net/blog/installation-et-utilisation-de-sentry/">Installation et utilisation de Sentry</a></li>
            
        </ul>
    </div>

    
    <div id="tags" class="open">
        <h3 data-open="tags">Tags</h3>
        <ul class="tags">
            
            <li><a href="/tags/astuce">astuce</a></li>
            
            <li><a href="/tags/cakephp">cakephp</a></li>
            
            <li><a href="/tags/doctrine">doctrine</a></li>
            
            <li><a href="/tags/golang">golang</a></li>
            
            <li><a href="/tags/joomla">joomla</a></li>
            
            <li><a href="/tags/php">php</a></li>
            
            <li><a href="/tags/solution">solution</a></li>
            
            <li><a href="/tags/symfony">symfony</a></li>
            
        </ul>
    </div>
    

    
</nav>

</div>
<div class="col-md-9 content">

<h1>Testing d&#39;une app golang sur AppEngine : une manière de gérer l&#39;erreur NewContext passed an unknown http.Request</h1>
<h4>Publié le 10-13-2016 19:38:59</h4>

<a href="https://twitter.com/share" class="twitter-share-button" data-via="kendo5731"></a>
<script>!function (d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0], p = /^http:/.test(d.location) ? 'http' : 'https';
    if (!d.getElementById(id)) {
        js = d.createElement(s);
        js.id = id;
        js.src = p + '://platform.twitter.com/widgets.js';
        fjs.parentNode.insertBefore(js, fjs);
    }
}(document, 'script', 'twitter-wjs');</script>

<div class="fb-share-button" data-href="http://www.aubm.net/blog/testing-d-une-app-golang-sur-appengine-une-maniere-de-gerer-l-erreur-newcontext-passed-an-unknown-http-request/" data-layout="button"></div>
<div id="fb-root"></div>
<script>(function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return;
    js = d.createElement(s); js.id = id;
    js.src = "//connect.facebook.net/fr_FR/sdk.js#xfbml=1&version=v2.5";
    fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>

<article>
    

<h2 id="tldr">TLDR;</h2>

<p>La solution sur Github : <a href="https://github.com/aubm/my-test-app">https://github.com/aubm/my-test-app</a></p>

<h2 id="mise-en-évidence-du-problème">Mise en évidence du problème</h2>

<p>Déployer du go sur AppEngine, c&rsquo;est cool, se retrouver perplexe lors de l&rsquo;éxecution des tests face à cette erreur : <code>panic: appengine: NewContext passed an unknown http.Request</code>, c&rsquo;est moins cool.</p>

<p>Trainer ces objets <code>context</code> un peu partout dans les couches de l&rsquo;application n&rsquo;est pas un aspect très agréable du développement d&rsquo;une appli web en go.
Sur AppEngine, c&rsquo;est d&rsquo;autant plus problématique que le contexte doit être créé à partir d&rsquo;une requête dont AppEngine a connaissance.</p>

<p>Dans le cas d&rsquo;un test, une requête passée en paramètre d&rsquo;un http handler est généralement créée programmatiquement à l&rsquo;aide de quelque chose comme <code>req, _ := http.NewRequest(&quot;GET&quot;, &quot;/&quot;, nil)</code>.</p>

<p>Utilisez cette requête pour créer un contexte avec <code>ctx := appengine.NewContext(r)</code> et votre application paniquera lamentablement.</p>

<p>Juste pour illustrer, voici un exemple de code que nous voudrions tester :</p>

<pre><code>package app

import (
    &quot;encoding/json&quot;
    &quot;net/http&quot;

    &quot;golang.org/x/net/context&quot;
    &quot;google.golang.org/appengine&quot;
)

func init() {
    booksHandlers := &amp;BooksHandlers{}

    http.HandleFunc(&quot;/books&quot;, booksHandlers.GetBooks)
}

type BooksHandlers struct {
    BooksService interface {
        FindAll(ctx context.Context) []Book
    }
}

func (h *BooksHandlers) GetBooks(w http.ResponseWriter, r *http.Request) {
    ctx := appengine.NewContext(r)

    books := h.BooksService.FindAll(ctx)

    w.Header().Set(&quot;Content-Type&quot;, &quot;application/json&quot;)
    if err := json.NewEncoder(w).Encode(books); err != nil {
        http.Error(w, &quot;An error occured when encoding JSON&quot;, 500)
    }
}

type Book struct {
    Title  string `json:&quot;title&quot;`
    Author string `json:&quot;author&quot;`
}
</code></pre>

<p>Le contenu du fichier de test :</p>

<pre><code>package app

import (
    &quot;net/http&quot;
    &quot;net/http/httptest&quot;
    &quot;testing&quot;

    &quot;golang.org/x/net/context&quot;
)

func TestGetBooks(t *testing.T) {
    w := httptest.NewRecorder()
    r, _ := http.NewRequest(&quot;GET&quot;, &quot;/&quot;, nil)

    mockBooksService := &amp;MockBooksService{}
    h := BooksHandlers{BooksService: mockBooksService}

    h.GetBooks(w, r)

    body := w.Body.String()
    expected := `[{&quot;title&quot;:&quot;The Lord of the Rings&quot;,&quot;author&quot;:&quot;J.J.R. Tolkien&quot;},{&quot;title&quot;:&quot;Harry Potter&quot;,&quot;author&quot;:&quot;J.K. Rolling&quot;}]
`

    if body != expected {
        t.Errorf(&quot;Expected %v, got %v&quot;, expected, body)
    }
}

type MockBooksService struct{}

func (m *MockBooksService) FindAll(ctx context.Context) []Book {
    return []Book{
        {Title: &quot;The Lord of the Rings&quot;, Author: &quot;J.J.R. Tolkien&quot;},
        {Title: &quot;Harry Potter&quot;, Author: &quot;J.K. Rolling&quot;},
    }
}
</code></pre>

<p>Et un extrait de la sortie standard :</p>

<pre><code>2016/10/13 20:05:10 appengine: NewContext passed an unknown http.Request
--- FAIL: TestGetBooks (0.00s)
panic: appengine: NewContext passed an unknown http.Request [recovered]
    panic: appengine: NewContext passed an unknown http.Request

goroutine 5 [running]:
panic(0x25f120, 0xc4201001b0)
    /usr/local/go/src/runtime/panic.go:500 +0x1a1
testing.tRunner.func1(0xc420090180)
    /usr/local/go/src/testing/testing.go:579 +0x25d
panic(0x25f120, 0xc4201001b0)
    /usr/local/go/src/runtime/panic.go:458 +0x243
</code></pre>

<p>Sur les forums, plusieurs solutions sont évoquées pour contourner le problème, ceci dit aucune ne m&rsquo;a réellement séduit.
Je vous présente maintenant une solution que je trouve suffisamment élégante pour retrouver le sommeil.</p>

<h2 id="une-solution">Une solution</h2>

<p>L&rsquo;idée est d&rsquo;encapsuler la création du contexte dans un service, que l&rsquo;on sera en capacité de remplacer par un mock pour les tests.</p>

<p>La définition du type <code>BooksHandlers</code> ressemble maintenant à ceci :</p>

<pre><code>type BooksHandlers struct {
    BooksService interface {
        FindAll(ctx context.Context) []Book
    }
    Context interface {
        Get(r *http.Request) context.Context
    }
}
</code></pre>

<p>Dans la méthode <code>GetBooks</code>, le contexte est maintenant créé de façon :</p>

<pre><code>ctx := h.Context.Get(r)
</code></pre>

<p>L&rsquo;implémentation utilisée pour <code>Context</code> est très simple :</p>

<pre><code>type ContextProvider struct{}

func (p *ContextProvider) Get(r *http.Request) context.Context {
    return appengine.NewContext(r)
}
</code></pre>

<p>Et il en va de même pour sa cousine mockée :</p>

<pre><code>type MockContextProvider struct{}

func (m *MockContextProvider) Get(r *http.Request) context.Context {
    return context.Background()
}
</code></pre>

<p>Tous les voyants sont maintenant au vert.
Voici le lien vers le code sur Github : <a href="https://github.com/aubm/my-test-app">https://github.com/aubm/my-test-app</a>.</p>

<p>A la prochaine !</p>

</article>

<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'wwwaubmnet';
    var disqus_identifier = 'http:\/\/www.aubm.net\/blog\/testing-d-une-app-golang-sur-appengine-une-maniere-de-gerer-l-erreur-newcontext-passed-an-unknown-http-request\/';
    var disqus_title = 'Testing d\x27une app golang sur AppEngine : une manière de gérer l\x27erreur NewContext passed an unknown http.Request';
    var disqus_url = 'http:\/\/www.aubm.net\/blog\/testing-d-une-app-golang-sur-appengine-une-maniere-de-gerer-l-erreur-newcontext-passed-an-unknown-http-request\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

</div>
</div>
<script src="js/theme.min.js" type="text/javascript"></script>

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-38043974-6', 'auto');
ga('send', 'pageview');
</script>


</body>
</html>

