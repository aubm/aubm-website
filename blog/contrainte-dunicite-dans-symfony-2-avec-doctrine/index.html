<!doctype html>
<html>
<head>
    <base href="/">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="author" content="Aurélien Baumann (Aubm)">

<meta name="description" content="">

<title>Contrainte d&#39;unicité dans Symfony 2 avec Doctrine</title>
<meta name="generator" content="Hugo 0.19-DEV" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.1.0/styles/pojoaque.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.1.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:400,700" rel="stylesheet" type="text/css">
<link  href="http://www.aubm.net/css/theme.min.css" rel="stylesheet" type="text/css">

</head>
<body>
<div class="page-container container-fluid">
<div class="col-md-3 menu">
    <nav class="col-md-3">
    <h3 class="home-link"><a href="/">Racine</a></h3>
    <div id="last-posts" class="open">
        <h3 data-open="last-posts">Aubm - Les derniers articles</h3>
        <ul>
            
            <li><a href="http://www.aubm.net/blog/pourquoi-big-o-est-important/">Pourquoi Big O est important ?</a></li>
            
            <li><a href="http://www.aubm.net/blog/comment-vous-faire-une-idee-d-l-impact-de-la-latence-de-votre-televiseur-dans-vos-sessions-de-jeux-videos/">Comment vous faire une idée de l&#39;impact de la latence de votre téléviseur dans vos sessions de jeux vidéos</a></li>
            
            <li><a href="http://www.aubm.net/blog/testing-d-une-app-golang-sur-appengine-une-maniere-de-gerer-l-erreur-newcontext-passed-an-unknown-http-request/">Testing d&#39;une app golang sur AppEngine : une manière de gérer l&#39;erreur NewContext passed an unknown http.Request</a></li>
            
            <li><a href="http://www.aubm.net/blog/l-injection-de-dependances-a-l-esprit-dans-vos-applications-golang/">L&#39;injection de dépendances à l&#39;esprit dans vos applications Golang</a></li>
            
            <li><a href="http://www.aubm.net/blog/aller-plus-loin-avec-postman/">Aller plus loin avec Postman</a></li>
            
            <li><a href="http://www.aubm.net/blog/du-neuf-sous-le-capot/">Du neuf sous le capot</a></li>
            
            <li><a href="http://www.aubm.net/blog/gardez-le-code-explicite-court-et-modulaire/">Gardez le code explicite, court et modulaire</a></li>
            
            <li><a href="http://www.aubm.net/blog/contrainte-dunicite-dans-symfony-2-avec-doctrine/">Contrainte d&#39;unicité dans Symfony 2 avec Doctrine</a></li>
            
            <li><a href="http://www.aubm.net/blog/mes-premiers-pas-avec-cakephp-3/">Mes premiers pas avec CakePHP 3</a></li>
            
            <li><a href="http://www.aubm.net/blog/installation-et-utilisation-de-sentry/">Installation et utilisation de Sentry</a></li>
            
        </ul>
    </div>

    
    <div id="tags" class="open">
        <h3 data-open="tags">Tags</h3>
        <ul class="tags">
            
            <li><a href="/tags/astuce">astuce</a></li>
            
            <li><a href="/tags/cakephp">cakephp</a></li>
            
            <li><a href="/tags/doctrine">doctrine</a></li>
            
            <li><a href="/tags/golang">golang</a></li>
            
            <li><a href="/tags/joomla">joomla</a></li>
            
            <li><a href="/tags/php">php</a></li>
            
            <li><a href="/tags/solution">solution</a></li>
            
            <li><a href="/tags/symfony">symfony</a></li>
            
        </ul>
    </div>
    

    
</nav>

</div>
<div class="col-md-9 content">

<h1>Contrainte d&#39;unicité dans Symfony 2 avec Doctrine</h1>
<h4>Publié le 03-22-2015 15:55:31</h4>

<a href="https://twitter.com/share" class="twitter-share-button" data-via="kendo5731"></a>
<script>!function (d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0], p = /^http:/.test(d.location) ? 'http' : 'https';
    if (!d.getElementById(id)) {
        js = d.createElement(s);
        js.id = id;
        js.src = p + '://platform.twitter.com/widgets.js';
        fjs.parentNode.insertBefore(js, fjs);
    }
}(document, 'script', 'twitter-wjs');</script>

<div class="fb-share-button" data-href="http://www.aubm.net/blog/contrainte-dunicite-dans-symfony-2-avec-doctrine/" data-layout="button"></div>
<div id="fb-root"></div>
<script>(function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return;
    js = d.createElement(s); js.id = id;
    js.src = "//connect.facebook.net/fr_FR/sdk.js#xfbml=1&version=v2.5";
    fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>

<article>
    

<h2 id="introduction">Introduction</h2>

<p>Le <a href="http://symfony.com/doc/current/book/validation.html" target="_blank">composant de validation de Symfony</a> embarque des contraintes pré-définies (outre la possibilité de créer des contraintes personnalisées évidemment). Par ailleurs, l&rsquo;intégration de Doctrine dans le framework full-stack fournit une autre contrainte prête à l&rsquo;emploi : <code>UniqueEntity</code>, qui permet de valider l&rsquo;unicité dans une table de la base de données d&rsquo;un ou plusieurs champs d&rsquo;une entité.</p>

<p>Cette contrainte est référencée dans la <a href="http://symfony.com/doc/current/reference/constraints/UniqueEntity.html" target="_blank">documentation officielle de Symfony</a>. Cet article se propose d&rsquo;apporter quelques exemples et explications en complément de cette documentation. J&rsquo;ajoute qu&rsquo;à l&rsquo;heure où j&rsquo;écris, la version en français de la documentation ne semble pas être à jour. Elle est en effet incomplète en comparaison avec la version anglaise qui recense un plus grand nombre d&rsquo;options.</p>

<h2 id="contexte">Contexte</h2>

<p>Les extraits de code de cet article sont issus de l&rsquo;application exemple <a href="https://github.com/aubm/Doctrine-Unique-Entity-Example-App" target="_blank">dont le code est disponible sur Github</a>. Il s&rsquo;agit d&rsquo;une application réalisée à l&rsquo;aide de Symfony 2.6 Standard Edition. La procédure à suivre pour installer l&rsquo;application en local (si jamais vous souhaitez tester) est la suivante :</p>

<ul>
<li>Installer les pré-requis nécessaires : Git, PHP &gt; 5.3, Composer, MySQL (ou un autre système de base de données compatible).</li>
<li>Cloner le repo <code>git clone https://github.com/aubm/Doctrine-Unique-Entity-Example-App.git</code> et se déplacer dans le répertoire du projet <code>cd Doctrine-Unique-Entity-Example-App/</code>.</li>
<li>Installer les dépendances avec Composer <code>composer install</code></li>
<li>Modifier au besoin le nom et les paramètres de connexion à la base de données dans <code>app/config/parameters.yml</code>.</li>
<li>Créer la base de données, vous pouvez le faire avec l&rsquo;outil cli <code>php app/console doctrine:database:create</code>.</li>
<li>Générer le schéma <code>php app/console doctrine:schema:update --dump-sql --force</code>.</li>
<li>Servir l&rsquo;app <code>php app/console server:run</code> (CTLR + C pour arrêter).</li>
</ul>

<p>Cette application est un système fictif de votes. Il est possible de lui adresser une requête HTTP qui ajoutera une entrée dans la table des votes. Un vote peut être positif ou négatif, cet état est représenté par la colonne <code>positive</code> supposée recevoir une valeur <code>1</code> ou <code>0</code>. Afin d&rsquo;illustrer l&rsquo;utilisation de la contrainte <code>UniqueEntity</code>, nous souhaitons ajouter une règle d&rsquo;unicité sur l&rsquo;IP entrante, afin de ne permettre à un client de n&rsquo;enregistrer qu&rsquo;un seul vote.</p>

<p>Si vous avez installé l&rsquo;application, vous pouvez lui adresser cette requête :</p>

<pre><code>POST /votes
positive=1
</code></pre>

<p>A défaut d&rsquo;autre chose, <a href="https://chrome.google.com/webstore/detail/postman-rest-client/fdmmgilgnpjigdojojpjoooidkmcomcm" target="_blank">Postman</a> est un outil très pratique pour construire des requêtes HTTP et les envoyer via une interface web.</p>

<h2 id="utiliser-la-contrainte-uniqueentity">Utiliser la contrainte UniqueEntity</h2>

<p>Ce code est extrait du contrôleur responsable de l&rsquo;enregistrement des votes :</p>

<pre><code class="language-php">public function createAction(Request $request)
{
    $votes_manager = $this-&gt;container-&gt;get('ab.voting_system.votes_manager');
    $vote = $votes_manager-&gt;newEntity([
            'remote_addr' =&gt; $request-&gt;server-&gt;get('REMOTE_ADDR')
        ] + $request-&gt;request-&gt;all());
    $validation_errors = $votes_manager-&gt;validateEntity($vote);
    if (count($validation_errors) == 0) {
        $votes_manager-&gt;saveEntity($vote);
        return new JsonResponse(null, 201);
    } else {
        return new JsonResponse(null, 400);
    }
}
</code></pre>

<p>L&rsquo;entité <code>Vote</code> est une simple classe contenant les attributs suivants :</p>

<pre><code class="language-php">class Vote
{
    private $id;
    private $positive;
    private $remote_addr;

    ...
}
</code></pre>

<p>Le mapping des attributs pour Doctrine est défini dans <a href="https://github.com/aubm/Doctrine-Unique-Entity-Example-App/blob/master/src/AB/VotingSystemBundle/Resources/config/doctrine/Vote.orm.yml" target="_blank"><code>src/AB/VotingSystemBundle/Resources/config/doctrine/Vote.orm.yml</code></a>.</p>

<p>Il est possible de réduire légèrement le contrôleur en passant par une classe de formulaire. Pour cette exemple, j&rsquo;ai fait le choix de valider manuellement l&rsquo;entité afin de faciliter la compréhension du code (notamment pour des lecteurs moins familiers avec le framework).
L&rsquo;ajout de la contrainte d&rsquo;unicité sur <code>remote_addr</code> peut être fait en yaml comme ceci :</p>

<pre><code># src/AB/VotingSystem/Resources/config/validation.yml
AB\VotingSystemBundle\Entity\Vote:
    constraints:
        - Symfony\Bridge\Doctrine\Validator\Constraints\UniqueEntity:
            fields: remote_addr
</code></pre>

<p>A ce niveau le contrôleur n&rsquo;autorisera pas l&rsquo;enregistrement d&rsquo;une nouvelle ligne si la valeur contenue dans <code>remote_addr</code> existe déjà dans la table. A noter que si notre application est servie derrière un proxy, il se peut qu&rsquo;elle ne se comporte pas comme nous le souhaitons. Auquel cas il serait judicieux d&rsquo;enregistrer également la valeur de l&rsquo;en-tête <code>HTTP_X_FORWARDED_FOR</code> afin de s&rsquo;assurer de l&rsquo;unicité de la paire <code>remote_addr</code> + <code>http_x_forwarded_for</code> dans la table.</p>

<p>Commençons par mettre à jour l&rsquo;entité <code>Vote</code> :</p>

<pre><code class="language-php">class Vote
{
    ...
    private $http_x_forwarded_for;
    ...
}
</code></pre>

<p>Puis le fichier de configuration des contraintes de validation :</p>

<pre><code># src/AB/VotingSystem/Resources/config/validation.yml
AB\VotingSystemBundle\Entity\Vote:
    constraints:
        - Symfony\Bridge\Doctrine\Validator\Constraints\UniqueEntity:
            fields: [remote_addr, http_x_forwarded_for]
</code></pre>

<p><code>fields</code> prend maintenant un tableau de champs à vérifier. Il faut préciser que Symfony s&rsquo;assurera de l&rsquo;unicité <em>du groupe de champs</em> et non des deux champs de manière isolée.</p>

<h2 id="contrainte-uniqueentity-et-champ-nullable">Contrainte UniqueEntity et champ nullable</h2>

<p>Un comportement par défaut de la contrainte <code>UniqueEntity</code> dont il faut être conscient est que celle-ci n&rsquo;enregistrera aucune erreur si un ou plusieurs champs ont une valeur nulle (autrement dit, la contrainte sera ignorée). Dans l&rsquo;état, il est donc possible dans la table en base de données d&rsquo;avoir ces valeurs enregistrées :</p>

<table class="table table-condensed">
<thead>
    <tr>
        <th>id</th>
        <th>positive</th>
        <th>remote_addr</th>
        <th>http_x_forwarded_for</th>
    </tr>
</thead>
<tbody>
    <tr>
        <td>1</td>
        <td>0</td>
        <td>80.13.81.94</td>
        <td>NULL</td>
    </tr>
    <tr>
        <td>2</td>
        <td>1</td>
        <td class="text-danger">213.80.109.42</td>
        <td>NULL</td>
    </tr>
    <tr>
        <td>3</td>
        <td>1</td>
        <td class="text-danger">213.80.109.42</td>
        <td>NULL</td>
    </tr>
    <tr>
        <td>4</td>
        <td>1</td>
        <td class="text-danger">213.80.109.42</td>
        <td>NULL</td>
    </tr>
</tbody>
</table>

<p>Dans le cas de cette application, ce comportement n&rsquo;est pas celui attendu. Il est donc nécessaire de définir une autre valeur pour l&rsquo;option <code>ignoreNull</code> :</p>

<pre><code># src/AB/VotingSystem/Resources/config/validation.yml
AB\VotingSystemBundle\Entity\Vote:
    constraints:
        - Symfony\Bridge\Doctrine\Validator\Constraints\UniqueEntity:
            fields: [remote_addr, http_x_forwarded_for]
            ignoreNull: false
</code></pre>

<p>Cette fois tout devrait être bon :)</p>

</article>

<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'wwwaubmnet';
    var disqus_identifier = 'http:\/\/www.aubm.net\/blog\/contrainte-dunicite-dans-symfony-2-avec-doctrine\/';
    var disqus_title = 'Contrainte d\x27unicité dans Symfony 2 avec Doctrine';
    var disqus_url = 'http:\/\/www.aubm.net\/blog\/contrainte-dunicite-dans-symfony-2-avec-doctrine\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

</div>
</div>
<script src="js/theme.min.js" type="text/javascript"></script>

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-38043974-6', 'auto');
ga('send', 'pageview');
</script>


</body>
</html>

