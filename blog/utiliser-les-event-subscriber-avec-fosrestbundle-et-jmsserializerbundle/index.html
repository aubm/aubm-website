<!doctype html>
<html>
<head>
    <base href="/">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="author" content="Aurélien Baumann (Aubm)">

<meta name="description" content="">

<title>Utiliser les Event Subscriber avec FosRestBundle et JMSSerializerBundle</title>
<meta name="generator" content="Hugo 0.19-DEV" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.1.0/styles/pojoaque.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.1.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:400,700" rel="stylesheet" type="text/css">
<link  href="http://www.aubm.net/css/theme.min.css" rel="stylesheet" type="text/css">

</head>
<body>
<div class="page-container container-fluid">
<div class="col-md-3 menu">
    <nav class="col-md-3">
    <h3 class="home-link"><a href="/">Racine</a></h3>
    <div id="last-posts" class="open">
        <h3 data-open="last-posts">Aubm - Les derniers articles</h3>
        <ul>
            
            <li><a href="http://www.aubm.net/blog/pourquoi-big-o-est-important/">Pourquoi Big O est important ?</a></li>
            
            <li><a href="http://www.aubm.net/blog/comment-vous-faire-une-idee-d-l-impact-de-la-latence-de-votre-televiseur-dans-vos-sessions-de-jeux-videos/">Comment vous faire une idée de l&#39;impact de la latence de votre téléviseur dans vos sessions de jeux vidéos</a></li>
            
            <li><a href="http://www.aubm.net/blog/testing-d-une-app-golang-sur-appengine-une-maniere-de-gerer-l-erreur-newcontext-passed-an-unknown-http-request/">Testing d&#39;une app golang sur AppEngine : une manière de gérer l&#39;erreur NewContext passed an unknown http.Request</a></li>
            
            <li><a href="http://www.aubm.net/blog/l-injection-de-dependances-a-l-esprit-dans-vos-applications-golang/">L&#39;injection de dépendances à l&#39;esprit dans vos applications Golang</a></li>
            
            <li><a href="http://www.aubm.net/blog/aller-plus-loin-avec-postman/">Aller plus loin avec Postman</a></li>
            
            <li><a href="http://www.aubm.net/blog/du-neuf-sous-le-capot/">Du neuf sous le capot</a></li>
            
            <li><a href="http://www.aubm.net/blog/gardez-le-code-explicite-court-et-modulaire/">Gardez le code explicite, court et modulaire</a></li>
            
            <li><a href="http://www.aubm.net/blog/contrainte-dunicite-dans-symfony-2-avec-doctrine/">Contrainte d&#39;unicité dans Symfony 2 avec Doctrine</a></li>
            
            <li><a href="http://www.aubm.net/blog/mes-premiers-pas-avec-cakephp-3/">Mes premiers pas avec CakePHP 3</a></li>
            
            <li><a href="http://www.aubm.net/blog/installation-et-utilisation-de-sentry/">Installation et utilisation de Sentry</a></li>
            
        </ul>
    </div>

    
    <div id="tags" class="open">
        <h3 data-open="tags">Tags</h3>
        <ul class="tags">
            
            <li><a href="/tags/astuce">astuce</a></li>
            
            <li><a href="/tags/cakephp">cakephp</a></li>
            
            <li><a href="/tags/doctrine">doctrine</a></li>
            
            <li><a href="/tags/golang">golang</a></li>
            
            <li><a href="/tags/joomla">joomla</a></li>
            
            <li><a href="/tags/php">php</a></li>
            
            <li><a href="/tags/solution">solution</a></li>
            
            <li><a href="/tags/symfony">symfony</a></li>
            
        </ul>
    </div>
    

    
</nav>

</div>
<div class="col-md-9 content">

<h1>Utiliser les Event Subscriber avec FosRestBundle et JMSSerializerBundle</h1>
<h4>Publié le 05-20-2014 20:26:49</h4>

<a href="https://twitter.com/share" class="twitter-share-button" data-via="kendo5731"></a>
<script>!function (d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0], p = /^http:/.test(d.location) ? 'http' : 'https';
    if (!d.getElementById(id)) {
        js = d.createElement(s);
        js.id = id;
        js.src = p + '://platform.twitter.com/widgets.js';
        fjs.parentNode.insertBefore(js, fjs);
    }
}(document, 'script', 'twitter-wjs');</script>

<div class="fb-share-button" data-href="http://www.aubm.net/blog/utiliser-les-event-subscriber-avec-fosrestbundle-et-jmsserializerbundle/" data-layout="button"></div>
<div id="fb-root"></div>
<script>(function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return;
    js = d.createElement(s); js.id = id;
    js.src = "//connect.facebook.net/fr_FR/sdk.js#xfbml=1&version=v2.5";
    fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>

<article>
    

<h2 id="présentation-de-la-problèmatique">Présentation de la problèmatique</h2>

<p>J&rsquo;écris cet article car j&rsquo;ai été confronté à une problématique lors d&rsquo;un projet que j&rsquo;ai réalisé il y a peu. Le projet impliquait la création d&rsquo;un webservice au standard Rest dans une application Symfony2. J&rsquo;ai fait le choix d&rsquo;utiliser FosRestBundle et JMSSerializerBundle. Pour en apprendre plus sur l&rsquo;utilisation de ces bundles, je vous invite à consulter <a href="http://obtao.com/blog/2013/12/creer-une-api-rest-dans-une-application-symfony/" target="_blank">cet article</a> du blog de obtao.com. Le problème auquel j&rsquo;ai été confronté était le suivant.</p>

<p>Une méthode du webservice devait retourner une collection d&rsquo;objets de la classe File suivante (j&rsquo;épure volontairement le code) :</p>

<pre><code class="language-php">class File
{
    private $id;
    private $originalClientName;
    private $filename;
}
</code></pre>

<p>Le nom du fichier original qui a été uploadé est conservé dans l&rsquo;attribut $originalClientName. Potentiellement, cet attribut contient des valeurs comme &ldquo;chat.jpg&rdquo; ou &ldquo;photos.zip&rdquo; L&rsquo;attribut $filename quant à lui contient le nom du fichier tel qu&rsquo;il est stocké sur le serveur, il s&rsquo;agit d&rsquo;une chaîne de caractères aléatoire générée lors de l&rsquo;enregistrement de l&rsquo;entité dans la base de données.</p>

<p>La représentation json retournée par le webservice pour chaque entité File devait être de la forme suivante.</p>

<pre><code class="language-json">{
    &quot;id&quot; : 34,
    &quot;originalClientName&quot; : &quot;chat.jpg&quot;,
    &quot;downloadUrl&quot; : &quot;http://mon-serveur.com/download/z3r4gez775gd2dczzdf261gr0y66e&quot;
}
</code></pre>

<p>Comme on peut le voir, l&rsquo;attribut $filename (supposé contenir la string <code>&quot;z3r4gez775gd2dczzdf261gr0y66e&quot;</code> dans cet exemple), n&rsquo;est pas directement retourné dans le flux. Il s&rsquo;agit en fait d&rsquo;une uri facilement exploitable pour le client, pointant directement vers la  resource. Ayant parcouru la document du JMSSerializerBundle j&rsquo;ai pensé à utiliser l&rsquo;annotion <code>@VirtualProperty</code> sur une méthode de mon entité File qui ressemblerait à ceci.</p>

<pre><code class="language-php">class File
{
    private $id;
    private $originalClientName;
    private $filename;

    /**
    * @VirtualProperty
    */
    public function getDownloadUrl()
    {
        return &quot;http://mon-serveur.com/download/&quot; . $this-&gt;filename;
    }
}
</code></pre>

<p>Je n&rsquo;aimais qu&rsquo;à moitié cette solution car elle m&rsquo;imposait d&rsquo;écrire mon uri &ldquo;en dur&rdquo; dans le code source de mon entité. Cela pouvait poser problème si pendant le développement je voulais changer de hostname et tout simplement passer d&rsquo;un environnement à un autre (dev -&gt; prod ou l&rsquo;inverse).</p>

<p>J&rsquo;ai donc voulu utiliser le service &ldquo;router&rdquo; de Symfony pour générer l&rsquo;uri dynamiquement. Sauf que manque de chance, utiliser un service dans une entité, ce n&rsquo;est pas si simple à faire. Et ce pour la bonne raison que c&rsquo;est une mauvaise pratique, l&rsquo;entité devant pouvoir exister de façon indépendante à tout service externe.</p>

<p>Epluchant les documentations et les forums, je ne trouvais pas de solution simple ou suffisamment &ldquo;good practice&rdquo; à mon goût pour régler le problème. J&rsquo;avais d&rsquo;abord réfléchi à une solution qui me permettrait d&rsquo;injecter un service dans une classe abtraite, ce qui me permettrait d&rsquo;appeler une méthode statique sur cette classe. Mais ça me paraissait bien compliqué à réaliser, voire même tout simplement impossible.</p>

<p>Je suis finalement tombé sur un forum, dans lequel une personne rencontrant une problématique semblable à la mienne se voyait soumettre un début de solution qui a pu m&rsquo;aider à me dépatouiller.</p>

<h2 id="ma-solution">Ma solution</h2>

<p>La solution que j&rsquo;ai choisie pour répondre à cette problématique consistait à utiliser la <a href="http://jmsyst.com/libs/serializer/master/event_system" target="_blank">gestion des évènements du serializer</a>. Concrétement, voici comment j&rsquo;ai exploité cette fonctionnalité dans mon webservice. Dans la configuration de mes services (au niveau de mon WebServiceBundle), j&rsquo;ai ajouté le service défini de la façon suivante :</p>

<pre><code>parameters:
    aubm_web_service.serialize_handler_file.class: Aubm\WebServiceBundle\SerializeEventHandler\FileHandler
services:
    aubm_web_service.serialize_handler_file:
    class: %aubm_web_service.serialize_handler_file.class%
    tags:
        - { name: jms_serializer.event_subscriber }
</code></pre>

<p>L&rsquo;astuce ici est d&rsquo;ajouter le tag <code>jms_serializer.event_subscriber</code> au service. Si vous n&rsquo;avez jamais travaillé avec les services taggés, n&rsquo;hésitez pas à parcourir rapidement la <a href="http://symfony.com/fr/doc/current/components/dependency_injection/tags.html" target="_blank">documentation officielle du framework</a> afin de mieux comprendre leur utilité. Le tag <code>jms_serializer.event_subscriber</code> va indiquer au serializer qu&rsquo;il doit effectuer un certains nombre d&rsquo;actions sur ce service lors de certaines étapes de la serialisation des objets. Le &ldquo;quoi effectuer&rdquo; et &ldquo;quand l&rsquo;effectuer&rdquo; sont définis dans le service lui même. Ce service doit implémenter l&rsquo;interface <code>\JMS\Serializer\EventDispatcher\EventSubscriberInterface</code> et doit donc implémenter la méthode statique <code>getSubscribedEvents</code>. Voici le code de la classe du service.</p>

<pre><code class="language-php">class FileHandler implements EventSubscriberInterface
{
    /**
    * {@inheritdoc}
    */
    public static function getSubscribedEvents()
    {
        return array(
            array('event' =&gt; 'serializer.pre_serialize', 'method' =&gt; 'onPreSerialize', 'class' =&gt; 'Aubm\WebServiceBundle\Entity\File'),
        );
    }

    public function onPreSerialize(PreSerializeEvent $event)
    {
        $file = $event-&gt;getObject();
        // effectuer des manipulation sur l'objet avant sa serialisation ...
    }
}
</code></pre>

<p>Dans la méthode onPreSerialize, je peux manipuler mon entité File comme je souhaite avant sa sérialisation. Par ailleurs, ma classe FileHandler est définie en tant que service dans ma configuration, je peux donc y injecter toutes les dépendances dont j&rsquo;ai besoin. Pour la suite, le code parle de lui-même &hellip;</p>

<p>Dans mon entité File &hellip;</p>

<pre><code class="language-php">class File
{
    ...

    private $downloadUrl;

    public function setDownloadUrl($downloadUrl)
    {
        $this-&gt;downloadUrl = $downloadUrl;
    }

    public function getDownloadUrl()
    {
        return $this-&gt;downloadUrl;
    }

    ...
}
</code></pre>

<p>Dans mon services.yml &hellip;</p>

<pre><code>parameters:
    aubm_web_service.serialize_handler_file.class: Aubm\WebServiceBundle\SerializeEventHandler\FileHandler
services:
    aubm_web_service.serialize_handler_file:
    class: %aubm_web_service.serialize_handler_file.class%
    arguments:
        router: &quot;@router&quot;
    tags:
        - { name: jms_serializer.event_subscriber }
</code></pre>

<p>Enfin, dans ma classe de service FileHandler &hellip;</p>

<pre><code class="language-php">public function onPreSerialize(PreSerializeEvent $event)
{
    $file = $event-&gt;getObject();
    $file-&gt;setDownloadUrl(
        $this-&gt;router-&gt;generate(&quot;aubm_download_file&quot;, array(
            &quot;filename&quot; =&gt; $file-&gt;getFilename()
        ));
    );
}
</code></pre>

<p>En espérant que cet article pourra aider des personnes à la recherche d&rsquo;une solution pour un problème similaire, merci de m&rsquo;avoir lu et n&rsquo;hésitez pas à backlinker :)</p>

<p>Aurélien.</p>

</article>

<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'wwwaubmnet';
    var disqus_identifier = 'http:\/\/www.aubm.net\/blog\/utiliser-les-event-subscriber-avec-fosrestbundle-et-jmsserializerbundle\/';
    var disqus_title = 'Utiliser les Event Subscriber avec FosRestBundle et JMSSerializerBundle';
    var disqus_url = 'http:\/\/www.aubm.net\/blog\/utiliser-les-event-subscriber-avec-fosrestbundle-et-jmsserializerbundle\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

</div>
</div>
<script src="js/theme.min.js" type="text/javascript"></script>

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-38043974-6', 'auto');
ga('send', 'pageview');
</script>


</body>
</html>

