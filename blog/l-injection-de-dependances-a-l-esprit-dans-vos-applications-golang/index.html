<!doctype html>
<html>
<head>
    <base href="/">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="author" content="Aurélien Baumann (Aubm)">

<meta name="description" content="">

<title>L&#39;injection de dépendances à l&#39;esprit dans vos applications Golang</title>
<meta name="generator" content="Hugo 0.19-DEV" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.1.0/styles/pojoaque.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.1.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:400,700" rel="stylesheet" type="text/css">
<link  href="http://www.aubm.net/css/theme.min.css" rel="stylesheet" type="text/css">

</head>
<body>
<div class="page-container container-fluid">
<div class="col-md-3 menu">
    <nav class="col-md-3">
    <h3 class="home-link"><a href="/">Racine</a></h3>
    <div id="last-posts" class="open">
        <h3 data-open="last-posts">Aubm - Les derniers articles</h3>
        <ul>
            
            <li><a href="http://www.aubm.net/blog/pourquoi-big-o-est-important/">Pourquoi Big O est important ?</a></li>
            
            <li><a href="http://www.aubm.net/blog/comment-vous-faire-une-idee-d-l-impact-de-la-latence-de-votre-televiseur-dans-vos-sessions-de-jeux-videos/">Comment vous faire une idée de l&#39;impact de la latence de votre téléviseur dans vos sessions de jeux vidéos</a></li>
            
            <li><a href="http://www.aubm.net/blog/testing-d-une-app-golang-sur-appengine-une-maniere-de-gerer-l-erreur-newcontext-passed-an-unknown-http-request/">Testing d&#39;une app golang sur AppEngine : une manière de gérer l&#39;erreur NewContext passed an unknown http.Request</a></li>
            
            <li><a href="http://www.aubm.net/blog/l-injection-de-dependances-a-l-esprit-dans-vos-applications-golang/">L&#39;injection de dépendances à l&#39;esprit dans vos applications Golang</a></li>
            
            <li><a href="http://www.aubm.net/blog/aller-plus-loin-avec-postman/">Aller plus loin avec Postman</a></li>
            
            <li><a href="http://www.aubm.net/blog/du-neuf-sous-le-capot/">Du neuf sous le capot</a></li>
            
            <li><a href="http://www.aubm.net/blog/gardez-le-code-explicite-court-et-modulaire/">Gardez le code explicite, court et modulaire</a></li>
            
            <li><a href="http://www.aubm.net/blog/contrainte-dunicite-dans-symfony-2-avec-doctrine/">Contrainte d&#39;unicité dans Symfony 2 avec Doctrine</a></li>
            
            <li><a href="http://www.aubm.net/blog/mes-premiers-pas-avec-cakephp-3/">Mes premiers pas avec CakePHP 3</a></li>
            
            <li><a href="http://www.aubm.net/blog/installation-et-utilisation-de-sentry/">Installation et utilisation de Sentry</a></li>
            
        </ul>
    </div>

    
    <div id="tags" class="open">
        <h3 data-open="tags">Tags</h3>
        <ul class="tags">
            
            <li><a href="/tags/astuce">astuce</a></li>
            
            <li><a href="/tags/cakephp">cakephp</a></li>
            
            <li><a href="/tags/doctrine">doctrine</a></li>
            
            <li><a href="/tags/golang">golang</a></li>
            
            <li><a href="/tags/joomla">joomla</a></li>
            
            <li><a href="/tags/php">php</a></li>
            
            <li><a href="/tags/solution">solution</a></li>
            
            <li><a href="/tags/symfony">symfony</a></li>
            
        </ul>
    </div>
    

    
</nav>

</div>
<div class="col-md-9 content">

<h1>L&#39;injection de dépendances à l&#39;esprit dans vos applications Golang</h1>
<h4>Publié le 05-09-2016 18:45:44</h4>

<a href="https://twitter.com/share" class="twitter-share-button" data-via="kendo5731"></a>
<script>!function (d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0], p = /^http:/.test(d.location) ? 'http' : 'https';
    if (!d.getElementById(id)) {
        js = d.createElement(s);
        js.id = id;
        js.src = p + '://platform.twitter.com/widgets.js';
        fjs.parentNode.insertBefore(js, fjs);
    }
}(document, 'script', 'twitter-wjs');</script>

<div class="fb-share-button" data-href="http://www.aubm.net/blog/l-injection-de-dependances-a-l-esprit-dans-vos-applications-golang/" data-layout="button"></div>
<div id="fb-root"></div>
<script>(function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return;
    js = d.createElement(s); js.id = id;
    js.src = "//connect.facebook.net/fr_FR/sdk.js#xfbml=1&version=v2.5";
    fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>

<article>
    

<p>L&rsquo;injection de dépendances est utilisée pour séparer les responsabilités entre les briques d&rsquo;une application.
Ce pattern couplé à une stratégie d&rsquo;abstraction utilisant efficacement des interfaces permet également
de simplifier l&rsquo;écriture des tests unitaires. L&rsquo;intérêt étant de pouvoir remplacer une implémentation par une autre, supprimant
ainsi les potentiels effets de bords (requête en base de données, écriture sur le disque, requête HTTP, etc &hellip;).</p>

<p>Dans cet article, je vais vous présenter une approche permettant d&rsquo;appliquer ces principes à du code Go de façon simple et pratique.</p>

<h2 id="un-problème">Un problème</h2>

<p>L&rsquo;apporche la plus directe pour récupérer une liste d&rsquo;articles en base de données et les servir au format JSON est la suivante :</p>

<pre><code>package main

import (
    &quot;database/sql&quot;
    &quot;encoding/json&quot;
    &quot;fmt&quot;
    &quot;net/http&quot;

    _ &quot;github.com/go-sql-driver/mysql&quot;
)

type Post struct {
    Title   string `json:&quot;title&quot;`
    Content string `json:&quot;content&quot;`
}

func main() {
    http.HandleFunc(&quot;/posts&quot;, func(w http.ResponseWriter, r *http.Request) {
        db, err := sql.Open(&quot;mysql&quot;, &quot;root:root@/my_posts&quot;)
        defer db.Close()
        rows, err := db.Query(&quot;SELECT title, content FROM posts&quot;)
        if err != nil {
            http.Error(w, &quot;Internal server error&quot;, 500)
            return
        }
        defer rows.Close()
        posts := []Post{}
        for rows.Next() {
            p := Post{}
            err := rows.Scan(&amp;p.Title, &amp;p.Content)
            if err != nil {
                http.Error(w, &quot;Internal server error&quot;, 500)
                return
            }
            posts = append(posts, p)
        }
        b, err := json.Marshal(posts)
        if err != nil {
            http.Error(w, &quot;Internal server error&quot;, 500)
            return
        }
        w.Write(b)
        w.Header().Set(&quot;Content-Type&quot;, &quot;application/json&quot;)
    })
    fmt.Println(&quot;Application started on port 8080&quot;)
    http.ListenAndServe(&quot;:8080&quot;, nil)
}
</code></pre>

<p>Le code est facile à comprendre et tient en moins de 50 lignes, cependant mis à l&rsquo;échelle d&rsquo;une application du monde réel,
il présente des défauts évidents :</p>

<ul>
<li>il est impossible de réutiliser la moindre portion de code</li>
<li>les différents rôles sont étroitement liés, les effets de bord de potentielles modifications dans la récupération des données
sur la construction de la réponse HTTP sont difficiles à contrôler</li>
<li>il ne permet pas d&rsquo;écrire de tests unitaires efficacement</li>
</ul>

<h2 id="une-solution">Une solution</h2>

<p>Construire l&rsquo;application avec l&rsquo;injection de dépendances à l&rsquo;esprit permet d&rsquo;apporter une solution à ces différents problèmes.
Dans cette nouvelle approche, plusieurs structures sont identifiées.</p>

<h3 id="un-serializer-json">Un serializer JSON</h3>

<pre><code>type DefaultEncoder struct{}

func (de *DefaultEncoder) ToJSON(w http.ResponseWriter, src interface{}) {
    b, err := json.Marshal(src)
    if err != nil {
        http.Error(w, &quot;Internal server error&quot;, 500)
        return
    }
    w.Write(b)
    w.Header().Set(&quot;Content-Type&quot;, &quot;application/json&quot;)
}
</code></pre>

<p>Cette structure expose une méthode <code>ToJSON</code> qui écrit la résultat sérialisé en JSON du second paramètre <code>src interface{}</code>
dans le premier <code>w http.ResponseWriter</code>.</p>

<h3 id="un-gestionnaire-contenant-le-code-métier-non-relatif-à-la-couche-http">Un gestionnaire contenant le code métier non relatif à la couche HTTP</h3>

<pre><code>type PostsManager struct {
    DB *sql.DB
}

func (pm *PostsManager) FindPosts() ([]Post, error) {
    rows, err := pm.DB.Query(&quot;SELECT title, content FROM posts&quot;)
    if err != nil {
        return nil, err
    }
    defer rows.Close()
    posts := []Post{}
    for rows.Next() {
        p := Post{}
        err := rows.Scan(&amp;p.Title, &amp;p.Content)
        if err != nil {
            return nil, err
        }
        posts = append(posts, p)
    }
    return posts, nil
}
</code></pre>

<p>Cette structure expose une méthode <code>FindPosts</code> qui founit en retour une liste de posts.
Il est nécessaire de fournir un pointeur vers une instance de <code>sql.DB</code> à la construction.
A noter que la construction de ce paramètre n&rsquo;est pas directement pris en charge par <code>PostsManager</code>, ce qui est offre
une certaine souplesse pour ce qui est de l&rsquo;écriture des tests. En effet il ne sera pas nécessaire de déployer une instance
de MySQL, enregistrer <a href="https://godoc.org/github.com/DATA-DOG/go-sqlmock">un driver de mocks</a> sera bien plus pratique.</p>

<h3 id="une-interface-http">Une interface HTTP</h3>

<pre><code>type PostsHandlers struct {
    Manager interface {
        FindPosts() ([]Post, error)
    }
    Encoder interface {
        ToJSON(w http.ResponseWriter, src interface{})
    }
}

func (ph *PostsHandlers) GetPosts(w http.ResponseWriter, r *http.Request) {
    posts, err := ph.Manager.FindPosts()
    if err != nil {
        http.Error(w, &quot;internal server error&quot;, 500)
        return
    }
    ph.Encoder.ToJSON(w, posts)
}
</code></pre>

<p>Cette structure expose une méthode <code>GetPosts</code> capable de servir une liste de posts traduite en JSON via une interface HTTP.
Il est intéressant de noter que cette structure possède deux dépendances définies comme étant des interfaces.
Bien évidemment, <code>DefaultEncoder</code> et <code>PostsManager</code> sont conçues de façon à satisfaire ces interfaces.
Encore une fois, outre la valeur apportée au regard du découplage du code, cela permet également de simplifier l&rsquo;écriture des tests
en <a href="https://github.com/stretchr/testify#mock-package">fournissant des mocks</a> à <code>PostsHandlers</code>.</p>

<h3 id="l-assemblage-simplifié-grâce-à-facebookgo-inject">L&rsquo;assemblage simplifié grâce à facebookgo/inject</h3>

<p>La fonction <code>main</code> est maintenant ramenée à :</p>

<pre><code>func main() {
    db, err := sql.Open(&quot;mysql&quot;, &quot;root:root@/my_posts&quot;)
    if err != nil {
        log.Fatal(err)
    }
    defer db.Close()

    postsManager := &amp;PostsManager{DB: db}
    encoder := &amp;DefaultEncoder{}
    postsHandlers := &amp;PostsHandlers{Manager: postsManager, Encoder: encoder}

    http.HandleFunc(&quot;/posts&quot;, postsHandlers.GetPosts)

    fmt.Println(&quot;Application started on port 8080&quot;)
    http.ListenAndServe(&quot;:8080&quot;, nil)
}
</code></pre>

<p>Il apparaît que si la construction de l&rsquo;arbre des dépendances est relativement simple dans ce cas, elle n&rsquo;en reste pas moins peu pratique.
Dans des cas plus complexes, il peut être intéressant de considérer l&rsquo;utilisation de <a href="https://github.com/facebookgo/inject">facebookgo/inject</a>.
Il s&rsquo;agit d&rsquo;une librarie capable de résoudre automatiquement les dépendances d&rsquo;une liste d&rsquo;objets incomplets, au runtime et sans génération de code.</p>

<p>La définition des structures, et la construction des objets ressemblent maintenant à ceci :</p>

<pre><code>type PostsHandlers struct {
    Manager interface {
        FindPosts() ([]Post, error)
    } `inject:&quot;&quot;`
    Encoder interface {
        ToJSON(w http.ResponseWriter, src interface{})
    } `inject:&quot;&quot;`
}
</code></pre>

<pre><code>type PostsManager struct {
    DB *sql.DB `inject:&quot;&quot;`
}
</code></pre>

<pre><code>type DefaultEncoder struct{}
</code></pre>

<p>A noter : le tag <code>inject:&quot;&quot;</code> sur les champs qu&rsquo;<code>inject</code> devra prendre en charge.</p>

<pre><code>var postsManager PostsManager
var encoder DefaultEncoder
var postsHandlers PostsHandlers

if err := inject.Populate(db, &amp;postsHandlers, &amp;encoder, &amp;postsManager); err != nil {
    fmt.Fprintln(os.Stderr, err)
    os.Exit(1)
}
</code></pre>

<p>Le code complet <a href="https://github.com/aubm/dependency-injection-by-example">est disponible ici</a> :).</p>

<p>Et vous, quelle(s) solution(s) utilisez-vous pour découpler efficacement votre code Go ? :)</p>

</article>

<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'wwwaubmnet';
    var disqus_identifier = 'http:\/\/www.aubm.net\/blog\/l-injection-de-dependances-a-l-esprit-dans-vos-applications-golang\/';
    var disqus_title = 'L\x27injection de dépendances à l\x27esprit dans vos applications Golang';
    var disqus_url = 'http:\/\/www.aubm.net\/blog\/l-injection-de-dependances-a-l-esprit-dans-vos-applications-golang\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

</div>
</div>
<script src="js/theme.min.js" type="text/javascript"></script>

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-38043974-6', 'auto');
ga('send', 'pageview');
</script>


</body>
</html>

